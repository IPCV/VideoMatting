Bootstrap: docker
From: nvidia/cuda:12.0.0-devel-ubuntu22.04

%labels
    Author Sergi Garcia Sarroca

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONUNBUFFERED=1
    export VIRTUAL_ENV=/opt/venv
    export PATH="$VIRTUAL_ENV/bin:$PATH"

%post
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime
    apt update && apt install -y tzdata
    dpkg-reconfigure -f noninteractive tzdata

    apt update && apt install -y software-properties-common git curl
    add-apt-repository ppa:deadsnakes/ppa -y
    apt update && apt install -y software-properties-common git curl build-essential \
        python3.12 python3.12-venv python3.12-dev python3.12-distutils

    python3.12 -m ensurepip --upgrade
    python3.12 -m pip install --upgrade pip setuptools wheel

    # Upgrade pip
    pip install --upgrade pip

    # Create and activate virtual environment
    python3.12 -m venv /venv
    export PATH="/venv/bin:$PATH"
    export VIRTUAL_ENV="/venv"

    # Install Python packages inside venv
    pip install torch torchvision torchaudio pims av einops packaging kornia opencv-python xlsxwriter opencv-contrib-python
    pip install timm Pillow numpy matplotlib easing_functions tensorboard pandas codecarbon
    pip install mamba-ssm[causal-conv1d] --no-build-isolation

%runscript
    # Activate venv automatically when running the container
    source /opt/venv/bin/activate
    exec python "$@"
